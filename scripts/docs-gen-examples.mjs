import fs from 'node:fs'
import { mkdir, readdir, rm, writeFile } from 'node:fs/promises'
import path from 'node:path'
import { fileURLToPath } from 'node:url'

function toTitle(value) {
  return toPascalCase(value).replace(/([a-z])([A-Z])/g, '$1 $2')
}

function toPascalCase(value) {
  return value.replace(/(^\w|[-_]\w)/g, (match) => match.replace(/[-_]/, '').toUpperCase())
}

const scriptsDir = path.dirname(fileURLToPath(import.meta.url))
const repoRoot = path.resolve(scriptsDir, '..')

const examplesDir = path.join(repoRoot, 'packages', 'docs', '.vitepress', 'examples')
const docsExamplesDir = path.join(repoRoot, 'packages', 'docs', 'examples')
const reactExamplesDir = path.join(examplesDir, 'react')
const svelteExamplesDir = path.join(examplesDir, 'svelte')
const solidExamplesDir = path.join(examplesDir, 'solid')

await mkdir(docsExamplesDir, { recursive: true })

const exampleFiles = fs.existsSync(examplesDir)
  ? (await readdir(examplesDir))
      .filter((file) => file.endsWith('.vue'))
      .sort((a, b) => a.localeCompare(b))
  : []

const expectedDocsFiles = new Set(
  exampleFiles.map((file) => `${path.basename(file, '.vue')}.md`),
)

for (const file of exampleFiles) {
  const slug = path.basename(file, '.vue')
  const title = toTitle(slug)
  const codeGroupItems = getCodeGroupItems(slug)

  const contents = [
    '<!-- This file is generated by scripts/docs-gen-examples.mjs. Do not edit by hand. -->',
    '',
    `# ${title}`,
    '',
    `<Demo component-name="${slug}">`,
    '',
    ':::tabs key:framework',
    '',
    ...codeGroupItems.flatMap((item) => [
      `== ${toPascalCase(item.label)}`,
      '',
      `<<< ${item.path}`,
      '',
    ]),
    ':::',
    '',
    '</Demo>',
    '',
  ].join('\n')

  await writeFile(path.join(docsExamplesDir, `${slug}.md`), contents, 'utf8')
}

const existingDocsFiles = (await readdir(docsExamplesDir))
  .filter((file) => file.endsWith('.md') && file !== 'AGENTS.md' && file !== 'index.md')

for (const file of existingDocsFiles) {
  if (expectedDocsFiles.has(file)) continue
  await rm(path.join(docsExamplesDir, file))
}

function getCodeGroupItems(slug) {
  const items = []
  const vueSourcePath = path.join(examplesDir, `${slug}.vue`)

  if (fs.existsSync(vueSourcePath)) {
    items.push({
      label: 'vue',
      path: `../.vitepress/examples/${slug}.vue`,
    })
  }

  if (fs.existsSync(path.join(reactExamplesDir, `${slug}.tsx`))) {
    items.push({
      label: 'react',
      path: `../.vitepress/examples/react/${slug}.tsx`,
    })
  }

  if (fs.existsSync(path.join(svelteExamplesDir, `${slug}.svelte`))) {
    items.push({
      label: 'svelte',
      path: `../.vitepress/examples/svelte/${slug}.svelte`,
    })
  }

  if (fs.existsSync(path.join(solidExamplesDir, `${slug}.tsx`))) {
    items.push({
      label: 'solid',
      path: `../.vitepress/examples/solid/${slug}.tsx`,
    })
  }

  return items
}
